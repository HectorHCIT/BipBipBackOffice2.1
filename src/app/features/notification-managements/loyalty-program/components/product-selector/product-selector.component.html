<div [formGroup]="productForm" class="flex flex-col gap-4">
  <!-- Brand and Product Selection -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Brand -->
    <div class="flex flex-col gap-2">
      <label class="font-semibold text-sm">
        Marca
        <span class="text-red-500">*</span>
      </label>
      <p-select
        formControlName="brand"
        [options]="getBrandOptions()"
        placeholder="Seleccionar marca"
        optionLabel="label"
        optionValue="value"
      />
    </div>

    <!-- Product -->
    <div class="flex flex-col gap-2">
      <label class="font-semibold text-sm">
        Producto
        <span class="text-red-500">*</span>
      </label>
      <p-select
        formControlName="productCode"
        [options]="getProductOptions()"
        placeholder="Seleccionar producto"
        optionLabel="label"
        optionValue="value"
        [loading]="isLoadingProducts()"
        (onChange)="onProductChange($event.value)"
      />
      @if (selectedBrandId() > 0 && !isLoadingProducts() && products().length === 0) {
      <small class="text-color-secondary">No hay productos disponibles para esta marca</small>
      }
    </div>

    <!-- Quantity -->
    <div class="flex flex-col gap-2">
      <label class="font-semibold text-sm">Cantidad</label>
      <p-inputnumber
        formControlName="quantity"
        [min]="1"
        [showButtons]="true"
        placeholder="Cantidad"
      />
    </div>
  </div>

  <!-- Modifiers Section -->
  @if (hasProductSelected() && !isLoadingModifiers()) {
  <div class="border-t border-surface pt-4">
    <div class="flex items-center justify-between mb-3">
      <h4 class="text-sm font-semibold m-0">
        Modificadores ({{ modifiers().length }} disponibles)
      </h4>
      <p-button
        label="Agregar Modificador"
        icon="pi pi-plus"
        size="small"
        [text]="true"
        (onClick)="onAddModifier()"
        [disabled]="modifiers().length === 0"
      />
    </div>

    <div formArrayName="modifiersProducts" class="flex flex-col gap-3">
      @for (modifier of modifiersArray.controls; track $index) {
      <div
        [formGroupName]="$index"
        class="grid grid-cols-1 md:grid-cols-5 gap-3 p-3 border border-surface rounded"
      >
        <!-- Modifier -->
        <div class="flex flex-col gap-2">
          <label class="font-semibold text-xs">Modificador</label>
          <p-select
            formControlName="modifierId"
            [options]="getModifierList()"
            placeholder="Seleccionar"
            optionLabel="label"
            optionValue="value"
            (onChange)="onModifierChange($event.value, $index)"
          />
        </div>

        <!-- Option -->
        <div class="flex flex-col gap-2">
          <label class="font-semibold text-xs">Opción</label>
          <p-select
            formControlName="modifierCode"
            [options]="getModifierOptions($index)"
            placeholder="Seleccionar opción"
            optionLabel="label"
            optionValue="value"
            [disabled]="!modifier.get('modifierId')?.value"
          />
        </div>

        <!-- Quantity -->
        <div class="flex flex-col gap-2">
          <label class="font-semibold text-xs">Cantidad</label>
          <p-inputnumber formControlName="quantity" [min]="1" [showButtons]="false" />
        </div>

        <!-- Active -->
        <div class="w-full items-center justify-center flex flex-col gap-2">
          <label class="font-semibold text-xs">Estado</label>
          <div class="flex items-center gap-2">
            <p-toggleswitch formControlName="modifierActive" />
          </div>
        </div>
        <!-- Remove -->
        <div class=" w-full flex items-end">
          <p-button
            icon="pi pi-trash"
            severity="danger"
            [text]="true"
            [rounded]="true"
            (onClick)="onRemoveModifier($index)"
          />
        </div>
      </div>
      } @if (modifiersArray.length === 0 && modifiers().length > 0) {
      <div class="text-center p-4 border border-dashed border-surface rounded">
        <p class="text-sm text-color-secondary m-0">
          No hay modificadores agregados. Haz clic en "Agregar Modificador" para comenzar.
        </p>
      </div>
      } @if (modifiers().length === 0) {
      <div class="text-center p-4 border border-dashed border-surface rounded">
        <p class="text-sm text-color-secondary m-0">
          No hay modificadores disponibles para este producto.
        </p>
      </div>
      }
    </div>
  </div>
  } @if (hasProductSelected() && isLoadingModifiers()) {
  <div class="text-center p-4">
    <i class="pi pi-spin pi-spinner text-2xl text-primary"></i>
    <p class="text-sm text-color-secondary mt-2">Cargando modificadores...</p>
  </div>
  }

  <!-- Active Toggle -->
  <div class="flex items-center gap-2">
    <label class="font-semibold text-sm">Producto Activo:</label>
    <p-toggleswitch formControlName="active" />
    <span class="text-sm">{{ productForm.get('active')?.value ? 'Sí' : 'No' }}</span>
  </div>
</div>
