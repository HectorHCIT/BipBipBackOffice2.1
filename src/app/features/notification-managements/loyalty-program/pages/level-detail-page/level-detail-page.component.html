<div class="flex flex-col gap-6">
  <!-- Breadcrumb -->
  <p-breadcrumb [model]="breadcrumbItems" [home]="home" />

  <!-- Header -->
  <p-card>
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-color m-0 mb-2">{{ pageTitle() }}</h1>
        <p class="text-color-secondary m-0">
          @if (isEditMode()) {
            Edita los datos del nivel de lealtad
          } @else {
            Crea un nuevo nivel de lealtad
          }
        </p>
      </div>
    </div>
  </p-card>

  <!-- Form -->
  <form [formGroup]="form()" (ngSubmit)="onSave()">
    <!-- Basic Information -->
    <p-card>
      <ng-template pTemplate="header">
        <div class="p-4">
          <h2 class="text-xl font-semibold m-0">Información Básica</h2>
        </div>
      </ng-template>

      <div class="flex flex-col gap-4">
        <!-- Level Name -->
        <div class="flex flex-col gap-2">
          <label for="levelName" class="font-semibold">
            Nombre del Nivel
            <span class="text-red-500">*</span>
          </label>
          <input
            pInputText
            id="levelName"
            formControlName="levelName"
            placeholder="Ej: Bronce, Plata, Oro..."
          />
          @if (form().get('levelName')?.invalid && form().get('levelName')?.touched) {
            <small class="text-red-500">El nombre es requerido (mínimo 3 caracteres)</small>
          }
        </div>

        <!-- Description -->
        <div class="flex flex-col gap-2">
          <label for="levelDesc" class="font-semibold">Descripción</label>
          <input
            pInputText
            id="levelDesc"
            formControlName="levelDesc"
            placeholder="Mensaje para el usuario"
          />
        </div>

        <!-- Points Range -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="flex flex-col gap-2">
            <label for="requieredPts" class="font-semibold">
              Puntos Mínimos
              <span class="text-red-500">*</span>
            </label>
            <p-inputnumber
              inputId="requieredPts"
              formControlName="requieredPts"
              [min]="minPoints()"
              [max]="maxPoints()"
              placeholder="Puntos requeridos"
            />
            <small class="text-color-secondary">
              Rango permitido: {{ minPoints() | number }} - {{ maxPoints() | number }}
            </small>
          </div>

          <div class="flex flex-col gap-2">
            <label for="maxPts" class="font-semibold">
              Puntos Máximos
              <span class="text-red-500">*</span>
            </label>
            <p-inputnumber
              inputId="maxPts"
              formControlName="maxPts"
              [min]="minPoints()"
              [max]="maxPoints()"
              placeholder="Límite de puntos"
            />
          </div>
        </div>

        <!-- Status Checkboxes -->
        <div class="flex gap-6">
          <div class="flex items-center gap-2">
            <p-checkbox formControlName="isActive" [binary]="true" inputId="isActive" />
            <label for="isActive">Activo</label>
          </div>

          <div class="flex items-center gap-2">
            <p-checkbox formControlName="isPublish" [binary]="true" inputId="isPublish" />
            <label for="isPublish">Publicado</label>
          </div>
        </div>
      </div>
    </p-card>

    <p-divider />

    <!-- Benefit Selector Form -->
    <app-benefit-selector
      [parentForm]="form()"
      [brands]="brands()"
    />

    <p-divider />

    <!-- Benefits Table -->
    <p-card>
      <ng-template pTemplate="header">
        <div class="p-4">
          <h2 class="text-xl font-semibold m-0">Beneficios Agregados ({{ benefitsArray.length }})</h2>
        </div>
      </ng-template>

      @if (benefitsArray.length === 0) {
        <div class="text-center p-8">
          <i class="pi pi-gift text-4xl text-color-secondary mb-3"></i>
          <p class="text-color-secondary m-0">
            No hay beneficios agregados. Usa el formulario de arriba para agregar beneficios.
          </p>
        </div>
      } @else {
        <p-table [value]="getBenefitsTableData()" [tableStyle]="{ 'min-width': '60rem' }">
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 80px">Tipo</th>
              <th>Nombre</th>
              <th>Descripción</th>
              <th style="width: 120px">Descuento</th>
              <th style="width: 150px">Producto</th>
              <th style="width: 100px">Estado</th>
              <th style="width: 100px" class="text-center">Acciones</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-benefit>
            <tr>
              <td>
                <p-tag
                  [value]="benefit.typeLabel"
                  [severity]="getBenefitSeverity(benefit.type)"
                />
              </td>
              <td>{{ benefit.name }}</td>
              <td>
                <div class="max-w-xs overflow-hidden text-ellipsis">
                  {{ benefit.description }}
                </div>
              </td>
              <td>
                @if (benefit.discount > 0) {
                  <span class="font-semibold">
                    {{ benefit.type === 'DF' ? ('$' + benefit.discount) : (benefit.discount + '%') }}
                  </span>
                } @else {
                  <span class="text-color-secondary">-</span>
                }
              </td>
              <td>
                @if (benefit.productDetails && benefit.productDetails.length > 0) {
                  <div class="flex flex-col gap-2">
                    @for (product of benefit.productDetails; track product.productIndex) {
                      <div class="p-2 border border-surface rounded bg-surface-50 dark:bg-surface-900">
                        <div class="flex flex-col gap-1">
                          <div class="flex items-center gap-2">
                            <i class="pi pi-box text-xs text-primary"></i>
                            <span class="text-xs font-semibold">{{ product.productCode }}</span>
                            @if (!product.active) {
                              <p-tag value="Inactivo" severity="secondary" styleClass="text-xs py-0 px-1" />
                            }
                          </div>
                          <div class="flex items-center gap-2 text-xs text-color-secondary">
                            <i class="pi pi-building"></i>
                            <span>{{ product.brandName }}</span>
                          </div>
                          <div class="flex items-center gap-2 text-xs text-color-secondary">
                            <i class="pi pi-hashtag"></i>
                            <span>Cant: {{ product.quantity }}</span>
                          </div>
                          @if (product.modifiers.length > 0) {
                            <p-divider styleClass="my-1" />
                            <div class="flex flex-col gap-1">
                              <span class="text-xs font-semibold text-color-secondary">Modificadores:</span>
                              @for (modifier of product.modifiers; track $index) {
                                <div class="flex items-center gap-2 text-xs pl-2">
                                  <i class="pi pi-circle-fill" [style.font-size]="'4px'"></i>
                                  <span>{{ modifier.modifierCode }} (x{{ modifier.quantity }})</span>
                                  @if (modifier.active) {
                                    <p-tag value="Activo" severity="success" styleClass="text-xs py-0 px-1" />
                                  }
                                </div>
                              }
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                } @else {
                  <span class="text-color-secondary">-</span>
                }
              </td>
              <td>
                <p-tag
                  [value]="benefit.active ? 'Activo' : 'Inactivo'"
                  [severity]="benefit.active ? 'success' : 'secondary'"
                />
              </td>
              <td class="text-center">
                <p-button
                  icon="pi pi-trash"
                  severity="danger"
                  [text]="true"
                  [rounded]="true"
                  (onClick)="onRemoveBenefit(benefit.index)"
                  size="small"
                />
              </td>
            </tr>
          </ng-template>
        </p-table>
      }
    </p-card>

    <!-- Footer Actions -->
    <div class="flex gap-3 justify-end mt-6">
      <p-button
        label="Cancelar"
        severity="secondary"
        [outlined]="true"
        (onClick)="onCancel()"
        [disabled]="isSaving()"
      />
      <p-button
        label="{{ isEditMode() ? 'Actualizar' : 'Crear' }} Nivel"
        icon="pi pi-check"
        type="submit"
        [loading]="isSaving()"
      />
    </div>
  </form>
</div>

<!-- Toast Messages -->
<p-toast />
