<p-toast />

<div class="p-6">
  <!-- Breadcrumb -->
  <p-breadcrumb
    [model]="breadcrumbItems"
    [home]="home"
    class="mb-4"
  />

  <!-- Header -->
  <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
        Público Objetivo
      </h1>
      <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
        Administra los públicos objetivos para las notificaciones
      </p>
    </div>

    <p-button
      label="Crear Público Objetivo"
      icon="pi pi-plus"
      (onClick)="onCreate()"
    />
  </div>

  <!-- Filters -->
  <div class="flex flex-col sm:flex-row gap-3 mb-6">
    <!-- Search -->
    <p-iconfield iconPosition="left" class="flex-1">
      <p-inputicon styleClass="pi pi-search" />
      <input
        pInputText
        type="text"
        placeholder="Buscar por nombre..."
        (input)="onSearch($event)"
        class="w-full"
      />
    </p-iconfield>

    <!-- Status Filter -->
    <p-select
      [options]="statusOptions"
      optionLabel="label"
      optionValue="value"
      placeholder="Estado"
      [ngModel]="filters().isActive"
      (ngModelChange)="onStatusFilterChange($event)"
      [style]="{ 'min-width': '12rem' }"
    />
  </div>

  <!-- Desktop Table -->
  <div class="hidden sm:block">
    <p-table
      [value]="targetAudiences()"
      [loading]="isLoading()"
      [lazy]="true"
      [paginator]="true"
      [rows]="filters().pageSize"
      [totalRecords]="totalRecords()"
      [first]="(filters().page - 1) * filters().pageSize"
      (onLazyLoad)="onPageChange($event)"
      styleClass="p-datatable-sm"
      [tableStyle]="{ 'min-width': '50rem' }"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 5rem">ID</th>
          <th>Nombre</th>
          <th>Descripción</th>
          <th class="text-center" style="width: 10rem">Alcance Est.</th>
          <th class="text-center" style="width: 8rem">Género</th>
          <th class="text-center" style="width: 10rem">Edad</th>
          <th class="text-center" style="width: 8rem">Estado</th>
          <th class="text-center" style="width: 8rem">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-audience>
        <tr>
          <td>{{ audience.audienciaId }}</td>
          <td>{{ audience.nameCriteria }}</td>
          <td>{{ audience.descCriteria }}</td>
          <td class="text-center">{{ audience.AlcanceEstimado | number }}</td>
          <td class="text-center">{{ audience.sexCriteria }}</td>
          <td class="text-center">{{ audience.ageCriteria }}</td>
          <td class="text-center">
            <p-tag
              [value]="getStatusLabel(audience.statusCriteria)"
              [severity]="getStatusSeverity(audience.statusCriteria)"
            />
          </td>
          <td class="text-center">
            <p-button
              icon="pi pi-ellipsis-v"
              [text]="true"
              [rounded]="true"
              (onClick)="op.toggle($event)"
            />
            <p-popover #op>
              <div class="flex flex-col gap-1 p-2">
                <p-button
                  label="Editar"
                  icon="pi pi-pencil"
                  [text]="true"
                  severity="secondary"
                  (onClick)="onEdit(audience); op.hide()"
                  class="w-full justify-start"
                />
              </div>
            </p-popover>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center py-4">
            No hay públicos objetivos disponibles
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Mobile Cards -->
  <div class="block sm:hidden">
    @if (isLoading()) {
      <div class="text-center py-8">
        <p-progressSpinner />
      </div>
    } @else if (targetAudiences().length === 0) {
      <p-card>
        <div class="text-center py-4">
          No hay públicos objetivos disponibles
        </div>
      </p-card>
    } @else {
      @for (audience of targetAudiences(); track audience.audienciaId) {
        <p-card styleClass="mb-4">
          <div class="flex justify-between items-start mb-3">
            <div>
              <div class="font-bold text-lg">{{ audience.nameCriteria }}</div>
              <div class="text-sm text-color-secondary">ID: {{ audience.audienciaId }}</div>
            </div>
            <p-button
              icon="pi pi-ellipsis-v"
              [text]="true"
              [rounded]="true"
              (onClick)="op.toggle($event)"
            />
            <p-popover #op>
              <div class="flex flex-col gap-1 p-2">
                <p-button
                  label="Editar"
                  icon="pi pi-pencil"
                  [text]="true"
                  severity="secondary"
                  (onClick)="onEdit(audience); op.hide()"
                  class="w-full justify-start"
                />
              </div>
            </p-popover>
          </div>

          <div class="flex flex-col gap-2">
            <div class="flex justify-between">
              <span class="text-color-secondary text-sm">Descripción</span>
              <span class="font-semibold">{{ audience.descCriteria }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-color-secondary text-sm">Alcance Est.</span>
              <span class="font-semibold">{{ audience.AlcanceEstimado | number }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-color-secondary text-sm">Género</span>
              <span class="font-semibold">{{ audience.sexCriteria }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-color-secondary text-sm">Edad</span>
              <span class="font-semibold">{{ audience.ageCriteria }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-color-secondary text-sm">Estado</span>
              <p-tag
                [value]="getStatusLabel(audience.statusCriteria)"
                [severity]="getStatusSeverity(audience.statusCriteria)"
              />
            </div>
          </div>
        </p-card>
      }

      <!-- Mobile Pagination -->
      <div class="flex justify-center mt-4">
        <p-button
          icon="pi pi-chevron-left"
          [disabled]="filters().page === 1"
          (onClick)="onPageChange({ first: (filters().page - 2) * filters().pageSize, rows: filters().pageSize })"
          [text]="true"
        />
        <span class="mx-4 flex items-center">
          Página {{ filters().page }} de {{ Math.ceil(totalRecords() / filters().pageSize) }}
        </span>
        <p-button
          icon="pi pi-chevron-right"
          [disabled]="filters().page >= Math.ceil(totalRecords() / filters().pageSize)"
          (onClick)="onPageChange({ first: filters().page * filters().pageSize, rows: filters().pageSize })"
          [text]="true"
        />
      </div>
    }
  </div>
</div>

<!-- Form Drawer -->
<app-target-audience-form
  [visible]="isFormVisible()"
  [targetAudience]="selectedTargetAudience()"
  (onClose)="onFormClose()"
  (onSave)="onFormSave()"
/>
