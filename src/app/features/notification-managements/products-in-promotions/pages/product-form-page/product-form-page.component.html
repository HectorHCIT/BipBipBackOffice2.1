<div class="p-6">
  <!-- Breadcrumb -->
  <div class="mb-4">
    <p-breadcrumb
      [model]="breadcrumbItems()"
      [home]="home"
    />
  </div>

  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">
        {{ isEditMode() ? 'Editar Producto en Promoción' : 'Nuevo Producto en Promoción' }}
      </h1>
      <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
        {{ isEditMode() ? 'Actualiza los datos del tag promocional' : 'Crea un nuevo tag promocional para un producto' }}
      </p>
    </div>

    <p-button
      label="Volver"
      icon="pi pi-arrow-left"
      severity="secondary"
      [outlined]="true"
      (onClick)="goBack()"
    />
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Formulario -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
      <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">
        Datos del Producto
      </h2>

      <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="space-y-5">
        <!-- Marca -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Marca <span class="text-red-500">*</span>
          </label>
          <p-select
            formControlName="brandId"
            [options]="brandsList()"
            optionLabel="name"
            optionValue="id"
            placeholder="Selecciona una marca"
            [filter]="true"
            filterPlaceholder="Buscar marca..."
            class="w-full"
            [disabled]="isEditMode()"
          />
          @if (productForm.get('brandId')?.invalid && productForm.get('brandId')?.touched) {
            <small class="text-red-500 mt-1 block">La marca es requerida</small>
          }
        </div>

        <!-- Producto -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Producto <span class="text-red-500">*</span>
          </label>
          <p-select
            formControlName="productId"
            [options]="productsList()"
            optionLabel="name"
            optionValue="productId"
            placeholder="Selecciona un producto"
            [filter]="true"
            filterPlaceholder="Buscar producto..."
            class="w-full"
            [disabled]="!selectedBrandId() || isEditMode()"
          >
            <ng-template pTemplate="item" let-item>
              <div class="flex items-center gap-3">
                <img
                  [src]="item.imageUrl"
                  [alt]="item.name"
                  class="w-10 h-10 rounded object-cover"
                />
                <div>
                  <div class="font-medium text-sm">{{ item.name }}</div>
                  <div class="text-xs text-gray-500">{{ formatPrice(item.price) }}</div>
                </div>
              </div>
            </ng-template>
          </p-select>
          @if (productForm.get('productId')?.invalid && productForm.get('productId')?.touched) {
            <small class="text-red-500 mt-1 block">El producto es requerido</small>
          }
        </div>

        <!-- Información del producto seleccionado -->
        @if (selectedProduct()) {
          <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
            <div class="flex items-center gap-3">
              <img
                [src]="selectedProduct()!.imageUrl"
                [alt]="selectedProduct()!.name"
                class="w-16 h-16 rounded object-cover"
              />
              <div class="flex-1">
                <div class="font-semibold text-gray-900 dark:text-gray-100">
                  {{ selectedProduct()!.name }}
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                  Precio actual: <span class="font-semibold">{{ formatPrice(selectedProduct()!.price) }}</span>
                </div>
                @if (discountPercentage()) {
                  <div class="text-sm text-green-600 dark:text-green-400 font-semibold">
                    Descuento: {{ discountPercentage() }}%
                  </div>
                }
              </div>
            </div>
          </div>
        }

        <!-- Texto del Tag -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Texto del Tag <span class="text-red-500">*</span>
          </label>
          <input
            pInputText
            type="text"
            formControlName="text"
            placeholder="Ej: ¡OFERTA!, NUEVO, -50%"
            class="w-full"
            maxlength="20"
          />
          <div class="flex justify-between mt-1">
            @if (productForm.get('text')?.invalid && productForm.get('text')?.touched) {
              <small class="text-red-500">El texto es requerido</small>
            } @else {
              <span></span>
            }
            <small class="text-gray-500">
              {{ productForm.get('text')?.value?.length || 0 }}/20
            </small>
          </div>
        </div>

        <!-- Colores -->
        <div class="grid grid-cols-2 gap-4">
          <!-- Color de Fondo -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Color de Fondo <span class="text-red-500">*</span>
            </label>
            <div class="flex items-center gap-2">
              <p-colorPicker
                formControlName="backgroundColor"
                format="hex"
              />
              <input
                pInputText
                type="text"
                formControlName="backgroundColor"
                class="flex-1"
                placeholder="#FF5733"
              />
            </div>
          </div>

          <!-- Color de Texto -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Color de Texto <span class="text-red-500">*</span>
            </label>
            <div class="flex items-center gap-2">
              <p-colorPicker
                formControlName="textColor"
                format="hex"
              />
              <input
                pInputText
                type="text"
                formControlName="textColor"
                class="flex-1"
                placeholder="#FFFFFF"
              />
            </div>
          </div>
        </div>

        <!-- Posición -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Posición del Tag <span class="text-red-500">*</span>
          </label>
          <p-select
            formControlName="position"
            [options]="positionOptions"
            optionLabel="label"
            optionValue="value"
            placeholder="Selecciona una posición"
            class="w-full"
          />
        </div>

        <!-- Precio Anterior (Opcional) -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Precio Anterior (Opcional)
          </label>
          <input
            pInputText
            type="number"
            formControlName="oldPrice"
            placeholder="Ej: 150.00"
            class="w-full"
            step="0.01"
            min="0"
          />
          <small class="text-gray-500 mt-1 block">
            Muestra el precio anterior tachado para destacar el descuento
          </small>
        </div>

        <!-- Botones -->
        <div class="flex gap-3 pt-4">
          <p-button
            label="Cancelar"
            severity="secondary"
            [outlined]="true"
            (onClick)="goBack()"
            type="button"
            [disabled]="isSaving()"
            class="flex-1"
          />
          <p-button
            [label]="isEditMode() ? 'Actualizar' : 'Crear'"
            icon="pi pi-check"
            type="submit"
            [loading]="isSaving()"
            class="flex-1"
          />
        </div>
      </form>
    </div>

    <!-- Vista Previa -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
      <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">
        Vista Previa
      </h2>

      <div class="space-y-4">
        <!-- Preview del Tag -->
        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-6">
          <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">Vista Previa del Tag Promocional</h3>

          <!-- Product Card Preview - Estilo Old Project -->
          <div class="w-full md:w-8/12 h-40 bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-600 flex overflow-hidden relative">
            @if (selectedProduct()) {
              <!-- Imagen del producto (1/3 izquierda) -->
              <div class="w-1/3 bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                <img
                  [src]="selectedProduct()!.imageUrl"
                  [alt]="selectedProduct()!.name"
                  class="w-full h-full object-cover"
                />
              </div>

              <!-- Info del producto (2/3 derecha) -->
              <div class="w-2/3 p-4 flex flex-col justify-center relative border-l border-gray-200 dark:border-gray-600">

                <!-- Tag en posición topLeft o topRight -->
                @if (tagPreview() && tagPreview()!.text && (tagPreview()!.position === 'topLeft' || tagPreview()!.position === 'topRight')) {
                  <div
                    class="absolute top-2 px-2 py-1 text-xs font-bold rounded-full shadow-sm"
                    [class.left-2]="tagPreview()!.position === 'topLeft'"
                    [class.right-2]="tagPreview()!.position === 'topRight'"
                    [style.background-color]="tagPreview()!.backgroundColor"
                    [style.color]="tagPreview()!.textColor"
                  >
                    {{ tagPreview()!.text }}
                  </div>
                }

                <!-- Nombre del producto -->
                <h4 class="font-semibold text-sm text-gray-900 dark:text-gray-100 mb-1 line-clamp-2">
                  {{ selectedProduct()!.name }}
                </h4>

                <!-- Precio -->
                <div class="flex items-center gap-2">
                  @if (productForm.get('oldPrice')?.value) {
                    <p class="text-sm text-gray-500 dark:text-gray-400 line-through">
                      L. {{ (+productForm.get('oldPrice')!.value).toFixed(2) }}
                    </p>
                  }
                  <p class="text-lg font-bold text-gray-800 dark:text-gray-200">
                     {{ formatPrice(selectedProduct()!.price) }}
                  </p>
                </div>

                <!-- Tag en posición bottomRight -->
                @if (tagPreview() && tagPreview()!.text && tagPreview()!.position === 'bottomRight') {
                  <div
                    class="absolute bottom-2 right-2 px-2 py-1 text-xs font-bold rounded-full shadow-sm"
                    [style.background-color]="tagPreview()!.backgroundColor"
                    [style.color]="tagPreview()!.textColor"
                  >
                    {{ tagPreview()!.text }}
                  </div>
                }
              </div>

            } @else {
              <!-- Placeholder cuando no hay producto -->
              <div class="w-1/3 bg-gray-100 dark:bg-gray-700 flex items-center justify-center">
                <i class="pi pi-image text-4xl text-gray-400"></i>
              </div>
              <div class="w-2/3 p-4 flex items-center justify-center border-l border-gray-200 dark:border-gray-600">
                <p class="text-sm text-gray-500 dark:text-gray-400">Selecciona un producto para ver la vista previa</p>
              </div>
            }
          </div>
        </div>

        <!-- Guía de Posiciones -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
          <div class="flex items-start gap-2">
            <i class="pi pi-info-circle text-blue-600 dark:text-blue-400 mt-0.5"></i>
            <div class="text-sm text-gray-700 dark:text-gray-300">
              <p class="font-semibold mb-2">Posiciones disponibles:</p>
              <ul class="space-y-1 text-xs">
                @for (option of positionOptions; track option.value) {
                  <li class="flex items-center gap-2">
                    <i [class]="'pi ' + ProductTagPositionUtils.getPositionIcon(option.value)"></i>
                    {{ option.label }}
                  </li>
                }
              </ul>
            </div>
          </div>
        </div>

        <!-- Tips -->
        <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-4">
          <div class="flex items-start gap-2">
            <i class="pi pi-lightbulb text-amber-600 dark:text-amber-400 mt-0.5"></i>
            <div class="text-sm text-gray-700 dark:text-gray-300">
              <p class="font-semibold mb-2">Tips:</p>
              <ul class="space-y-1 text-xs list-disc list-inside">
                <li>Usa textos cortos y llamativos</li>
                <li>Asegúrate de que haya buen contraste entre el texto y el fondo</li>
                <li>El precio anterior debe ser mayor al precio actual</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<p-toast />
