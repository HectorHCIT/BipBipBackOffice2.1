<div class="flex flex-col gap-4 p-4">
  <!-- Header -->
  <div class="flex flex-col gap-4">
    <!-- Breadcrumb -->
    <p-breadcrumb [model]="breadcrumbItems" [home]="home" />

    <!-- Título -->
    <div>
      <h1 class="text-2xl font-bold ">Órdenes por Cliente</h1>
      <p class="text-sm text-gray-600 mt-1">
        Consulta y visualización de órdenes de clientes
      </p>
    </div>

    <!-- Barra de Búsqueda y Filtros -->
    <div class="flex flex-col md:flex-row gap-3">
      <!-- Búsqueda -->
      <div class="flex-1">
        <p-iconfield iconPosition="left" class="w-full">
          <p-inputicon styleClass="pi pi-search" />
          <input
            pInputText
            type="text"
            placeholder="Buscar por número de orden, teléfono o nombre..."
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
            class="w-full"
          />
        </p-iconfield>
      </div>

      <!-- Filtro de Tiempo -->
      <div class="w-full md:w-60">
        <p-select
          [(ngModel)]="selectedTimeFilter"
          [options]="timeFilters"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccione período"
          styleClass="w-full"
          (onChange)="onTimeFilterChange()"
        />
      </div>

      <!-- Botón Limpiar (solo si hay búsqueda) -->
      @if (hasSearch()) {
        <p-button
          icon="pi pi-times"
          label="Limpiar"
          severity="secondary"
          [outlined]="true"
          (onClick)="clearSearch()"
        />
      }
    </div>
  </div>

  <!-- Tabla Desktop -->
  <div class="hidden md:block">
    <p-table
      [value]="orders()"
      [lazy]="true"
      [paginator]="true"
      [rows]="rowsPerPage()"
      [totalRecords]="totalRecords()"
      [rowsPerPageOptions]="rowsPerPageOptions"
      [loading]="isLoading()"
      (onLazyLoad)="onPageChange($event)"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} órdenes"
      styleClass="p-datatable-sm p-datatable-striped"
    >
      <!-- Columnas -->
      <ng-template #header>
        <tr>
          <th>No. Orden</th>
          <th>POSGC</th>
          <th>Detalles Pedido</th>
          <th>Estado / Método Pago</th>
          <th>Monto</th>
          <th>Fecha</th>
          <th>Recepción</th>
          <th>Entrega</th>
          <th>Estado Orden</th>
        </tr>
      </ng-template>

      <ng-template #body let-order>
        <tr>
          <!-- No. Orden -->
          <td>
            <span class="font-semibold text-gray-900">#{{ order.numOrder }}</span>
          </td>

          <!-- POSGC -->
          <td>
            @if (order.posgcId) {
              <span class="text-gray-700">{{ order.posgcId }}</span>
            } @else {
              <span class="text-gray-400">-</span>
            }
          </td>

          <!-- Detalles Pedido -->
          <td>
            <div class="max-w-xs">
              <span class="text-sm text-gray-700 line-clamp-2" [title]="order.orderDetails">
                {{ order.orderDetails }}
              </span>
            </div>
          </td>

          <!-- Estado / Método Pago -->
          <td>
            <div class="flex flex-col gap-1">
              <span class="text-sm font-medium text-gray-900">{{ order.generalStatus }}</span>
              <span class="text-xs text-gray-500">{{ order.paymentMethod }}</span>
            </div>
          </td>

          <!-- Monto -->
          <td>
            <span class="font-semibold text-gray-900">{{ formatAmount(order.orderAmount) }}</span>
          </td>

          <!-- Fecha -->
          <td>
            <span class="text-sm text-gray-700">{{ formatDate(order.orderDate) }}</span>
          </td>

          <!-- Recepción -->
          <td>
            <span class="text-sm text-gray-700">{{ order.reception || '-' }}</span>
          </td>

          <!-- Entrega -->
          <td>
            <span class="text-sm text-gray-700">{{ order.shipping || '-' }}</span>
          </td>

          <!-- Estado Orden -->
          <td>
            <p-tag
              [value]="order.orderStatus"
              [severity]="getOrderStatusSeverity(order.orderStatus)"
            />
          </td>
        </tr>
      </ng-template>

      <!-- Loading -->
      <ng-template #loadingbody>
        <tr>
          <td colspan="9">
            <div class="flex flex-col gap-2 p-4">
              @for (i of [1,2,3]; track i) {
                <p-skeleton height="3rem" />
              }
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Empty -->
      <ng-template #emptymessage>
        <tr>
          <td colspan="9">
            <div class="flex flex-col items-center justify-center py-8 text-gray-500">
              <i class="pi pi-inbox text-4xl mb-3"></i>
              <p class="text-lg font-semibold">No se encontraron órdenes</p>
              <p class="text-sm">
                @if (hasSearch()) {
                  Intenta con otro término de búsqueda
                } @else {
                  No hay órdenes en el período seleccionado
                }
              </p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Cards Mobile -->
  <div class="md:hidden space-y-3">
    @if (isLoading()) {
      @for (i of [1,2,3]; track i) {
        <p-skeleton height="16rem" />
      }
    } @else if (orders().length === 0) {
      <div class="flex flex-col items-center justify-center py-12 text-gray-500">
        <i class="pi pi-inbox text-5xl mb-4"></i>
        <p class="text-lg font-semibold">No se encontraron órdenes</p>
      </div>
    } @else {
      @for (order of orders(); track order.numOrder) {
        <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
          <!-- Header -->
          <div class="flex items-start justify-between mb-3">
            <div>
              <span class="text-lg font-bold text-gray-900">#{{ order.numOrder }}</span>
              @if (order.posgcId) {
                <p class="text-xs text-gray-500 mt-1">POSGC: {{ order.posgcId }}</p>
              }
            </div>
            <p-tag
              [value]="order.orderStatus"
              [severity]="getOrderStatusSeverity(order.orderStatus)"
            />
          </div>

          <!-- Detalles -->
          <div class="mb-3 pb-3 border-b border-gray-200">
            <p class="text-sm text-gray-700 line-clamp-2">{{ order.orderDetails }}</p>
          </div>

          <!-- Info Grid -->
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <p class="text-xs text-gray-500">Monto</p>
              <p class="text-sm font-semibold text-gray-900">{{ formatAmount(order.orderAmount) }}</p>
            </div>

            <div>
              <p class="text-xs text-gray-500">Fecha</p>
              <p class="text-sm font-medium text-gray-900">{{ formatDate(order.orderDate) }}</p>
            </div>

            <div>
              <p class="text-xs text-gray-500">Estado Pago</p>
              <p class="text-sm font-medium text-gray-900">{{ order.generalStatus }}</p>
            </div>

            <div>
              <p class="text-xs text-gray-500">Método Pago</p>
              <p class="text-sm font-medium text-gray-900">{{ order.paymentMethod }}</p>
            </div>

            <div>
              <p class="text-xs text-gray-500">Recepción</p>
              <p class="text-sm font-medium text-gray-900">{{ order.reception || '-' }}</p>
            </div>

            <div>
              <p class="text-xs text-gray-500">Entrega</p>
              <p class="text-sm font-medium text-gray-900">{{ order.shipping || '-' }}</p>
            </div>
          </div>
        </div>
      }
    }

    <!-- Paginación Mobile -->
    @if (orders().length > 0) {
      <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg">
        <span class="text-sm text-gray-600">
          Total: {{ totalRecords() }} órdenes
        </span>
        <div class="flex gap-2">
          <p-button
            icon="pi pi-chevron-left"
            [rounded]="true"
            [outlined]="true"
            size="small"
            [disabled]="currentPage() === 1"
            (onClick)="onPageChange({ page: currentPage() - 2, rows: rowsPerPage() })"
          />
          <p-button
            icon="pi pi-chevron-right"
            [rounded]="true"
            [outlined]="true"
            size="small"
            [disabled]="currentPage() * rowsPerPage() >= totalRecords()"
            (onClick)="onPageChange({ page: currentPage(), rows: rowsPerPage() })"
          />
        </div>
      </div>
    }
  </div>
</div>

<!-- Toast -->
<p-toast />
