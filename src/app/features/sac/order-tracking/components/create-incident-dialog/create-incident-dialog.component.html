<p-dialog
  [visible]="visible()"
  [header]="'Crear incidencia - Orden #' + orderNumber()"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="w-full max-w-2xl"
  (visibleChange)="onVisibleChange($event)"
>
  <form [formGroup]="incidentForm" (ngSubmit)="onSubmit()" class="space-y-4">
    <div class="border-l-4 border-orange-400 bg-orange-50 p-4 rounded mb-4">
      <div class="flex items-start gap-3">
        <i class="pi pi-exclamation-circle text-orange-600 text-xl mt-0.5"></i>
        <div>
          <h4 class="text-sm font-semibold text-orange-800 mb-1">Registrar incidencia</h4>
          <p class="text-sm text-orange-700">
            Complete el formulario para registrar una incidencia relacionada con esta orden.
          </p>
        </div>
      </div>
    </div>

    <!-- Reason -->
    <div class="flex flex-col gap-2">
      <label for="reason" class="text-sm font-semibold text-gray-700">
        Motivo de la incidencia <span class="text-red-500">*</span>
      </label>
      <p-select
        inputId="reason"
        formControlName="reason"
        [options]="incidentTypes"
        optionLabel="label"
        optionValue="value"
        placeholder="Seleccione el motivo"
        styleClass="w-full"
        [class.ng-invalid]="isFieldInvalid('reason')"
        [class.ng-dirty]="isFieldInvalid('reason')"
      />
      @if (isFieldInvalid('reason')) {
        <small class="text-red-500">{{ getFieldError('reason') }}</small>
      }
    </div>

    <!-- Comment -->
    <div class="flex flex-col gap-2">
      <label for="comment" class="text-sm font-semibold text-gray-700">
        Comentario <span class="text-red-500">*</span>
      </label>
      <textarea
        pTextarea
        id="comment"
        formControlName="comment"
        placeholder="Describa detalladamente la incidencia"
        rows="4"
        class="w-full"
        [class.ng-invalid]="isFieldInvalid('comment')"
        [class.ng-dirty]="isFieldInvalid('comment')"
      ></textarea>
      @if (isFieldInvalid('comment')) {
        <small class="text-red-500">{{ getFieldError('comment') }}</small>
      }
    </div>

    <!-- Solution -->
    <div class="flex flex-col gap-2">
      <label for="solution" class="text-sm font-semibold text-gray-700">
        Solución propuesta <span class="text-red-500">*</span>
      </label>
      <textarea
        pTextarea
        id="solution"
        formControlName="solution"
        placeholder="Describa la solución propuesta para esta incidencia"
        rows="3"
        class="w-full"
        [class.ng-invalid]="isFieldInvalid('solution')"
        [class.ng-dirty]="isFieldInvalid('solution')"
      ></textarea>
      @if (isFieldInvalid('solution')) {
        <small class="text-red-500">{{ getFieldError('solution') }}</small>
      }
    </div>

    <!-- Attendant -->
    <div class="flex flex-col gap-2">
      <label for="attendant" class="text-sm font-semibold text-gray-700">
        Encargado <span class="text-red-500">*</span>
      </label>
      <input
        pInputText
        id="attendant"
        formControlName="attendant"
        placeholder="Nombre de quien registra la incidencia"
        class="w-full"
        [class.ng-invalid]="isFieldInvalid('attendant')"
        [class.ng-dirty]="isFieldInvalid('attendant')"
      />
      @if (isFieldInvalid('attendant')) {
        <small class="text-red-500">{{ getFieldError('attendant') }}</small>
      }
    </div>
  </form>

  <ng-template #footer>
    <div class="flex justify-end gap-2">
      <p-button
        label="Cancelar"
        severity="secondary"
        [outlined]="true"
        (onClick)="onCancel()"
        [disabled]="loading()"
      />
      <p-button
        label="Crear incidencia"
        severity="primary"
        icon="pi pi-plus"
        (onClick)="onSubmit()"
        [loading]="loading()"
        [disabled]="incidentForm.invalid"
      />
    </div>
  </ng-template>
</p-dialog>
