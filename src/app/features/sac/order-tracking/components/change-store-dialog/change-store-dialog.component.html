<p-dialog
  [visible]="visible()"
  (visibleChange)="visibleChange.emit($event)"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="w-full max-w-2xl"
>
  <ng-template #header>
    <div class="flex items-center gap-3">
      <i class="pi pi-building text-2xl text-blue-600"></i>
      <div>
        <h2 class="text-xl font-bold text-gray-900">Cambiar Restaurante</h2>
        <p class="text-sm text-gray-600">Orden #{{ orderId() }}</p>
      </div>
    </div>
  </ng-template>

  <!-- Content -->
  <div class="space-y-4 py-2">
    <!-- Current Store Info -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="flex items-center gap-2 mb-1">
        <i class="pi pi-building text-blue-600"></i>
        <span class="text-sm font-semibold text-blue-900">Restaurante Actual</span>
      </div>
      <p class="text-base font-medium text-blue-900 ml-6">{{ currentStoreName() }}</p>
    </div>

    <!-- Warning Message -->
    <p-message
      severity="warn"
      styleClass="w-full"
    >
      <ng-template #content>
        <div class="flex flex-col gap-1">
          <span class="font-semibold">Atención</span>
          <span class="text-sm">Esta acción cambiará el restaurante asignado a la orden. Asegúrese de coordinar con ambas tiendas antes de realizar el cambio.</span>
        </div>
      </ng-template>
    </p-message>

    <!-- Form -->
    <form [formGroup]="changeStoreForm" (ngSubmit)="onSubmit()" class="space-y-4">
      <!-- New Store Selection -->
      <div class="flex flex-col gap-2">
        <label for="newStoreId" class="text-sm font-semibold text-gray-700">
          Nuevo Restaurante <span class="text-red-500">*</span>
        </label>
        <p-select
          inputId="newStoreId"
          formControlName="newStoreId"
          [options]="stores()"
          optionLabel="shortName"
          optionValue="restId"
          placeholder="Seleccione el nuevo restaurante"
          [loading]="loadingStores()"
          [filter]="true"
          filterPlaceholder="Buscar restaurante..."
          styleClass="w-full"
          [class.ng-invalid]="isFieldInvalid('newStoreId')"
          [class.ng-dirty]="isFieldInvalid('newStoreId')"
        >
          <ng-template #item let-store>
            <div class="flex items-center gap-2">
              <i class="pi pi-building text-sm text-gray-600"></i>
              <span>{{ store.shortName }}</span>
            </div>
          </ng-template>
        </p-select>
        @if (isFieldInvalid('newStoreId')) {
          <small class="text-red-500">{{ getFieldError('newStoreId') }}</small>
        }
        @if (loadingStores()) {
          <small class="text-gray-600 flex items-center gap-1">
            <i class="pi pi-spin pi-spinner text-xs"></i>
            Cargando restaurantes...
          </small>
        }
      </div>

      <!-- Preview of change (if store selected) -->
      @if (getSelectedStoreName()) {
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <div class="flex items-center gap-2 mb-2">
            <i class="pi pi-arrow-right text-green-600"></i>
            <span class="text-sm font-semibold text-green-900">Cambio a Realizar</span>
          </div>
          <div class="ml-6 space-y-1">
            <div class="flex items-center gap-2 text-sm text-gray-600">
              <span>De:</span>
              <span class="font-medium text-gray-900">{{ currentStoreName() }}</span>
            </div>
            <div class="flex items-center gap-2 text-sm text-gray-600">
              <span>A:</span>
              <span class="font-medium text-green-700">{{ getSelectedStoreName() }}</span>
            </div>
          </div>
        </div>
      }

      <!-- Comments -->
      <div class="flex flex-col gap-2">
        <label for="comments" class="text-sm font-semibold text-gray-700">
          Motivo del Cambio <span class="text-red-500">*</span>
        </label>
        <textarea
          pTextarea
          id="comments"
          formControlName="comments"
          rows="4"
          placeholder="Describa el motivo del cambio de restaurante..."
          [class.ng-invalid]="isFieldInvalid('comments')"
          [class.ng-dirty]="isFieldInvalid('comments')"
          styleClass="w-full"
        ></textarea>
        @if (isFieldInvalid('comments')) {
          <small class="text-red-500">{{ getFieldError('comments') }}</small>
        }
        <small class="text-gray-600">
          Explique por qué se está cambiando el restaurante (ej: "Restaurante original sin producto", "Cercanía al cliente", etc.)
        </small>
      </div>
    </form>
  </div>

  <!-- Footer -->
  <ng-template #footer>
    <div class="flex justify-end gap-2">
      <p-button
        label="Cancelar"
        severity="secondary"
        [outlined]="true"
        (onClick)="onCancel()"
        [disabled]="isSubmitting()"
      />
      <p-button
        label="Cambiar Restaurante"
        severity="primary"
        icon="pi pi-building"
        (onClick)="onSubmit()"
        [loading]="isSubmitting()"
        [disabled]="changeStoreForm.invalid || loadingStores()"
      />
    </div>
  </ng-template>
</p-dialog>
