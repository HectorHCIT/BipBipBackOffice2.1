<!-- Toast notifications -->
<p-toast />

<!-- Confirm dialog -->
<p-confirmDialog />

<!-- Breadcrumb -->
<p-breadcrumb
  [model]="breadcrumbItems"
  [home]="home"
  class="mb-4"
/>

<!-- Page header -->
<div class="flex justify-between items-center mb-6">
  <div>
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Gestión de Ocurrencias</h1>
    <p class="text-gray-600">Administra las incidencias reportadas en el sistema</p>
  </div>
  <div class="flex gap-2">
    <p-button
      label="Reporte"
      icon="pi pi-file-excel"
      [outlined]="true"
      routerLink="reports"
    />
  </div>
</div>

<!-- Search and filters -->
<div class=" rounded-lg shadow-sm p-4 mb-4">
  <div class="flex gap-4 items-center">
    <div class="flex-1">
      <p-iconfield iconPosition="left">
        <p-inputicon styleClass="pi pi-search" />
        <input
          pInputText
          type="text"
          placeholder="Buscar por número de orden..."
          [(ngModel)]="searchTerm"
          class="w-full"
        />
      </p-iconfield>
    </div>
    <p-button
      label="Limpiar"
      icon="pi pi-times"
      [outlined]="true"
      severity="secondary"
      (onClick)="searchTerm.set('')"
      [disabled]="!searchTerm()"
    />
  </div>
</div>

<!-- Table -->
<div class=" rounded-lg shadow-sm">
  @if (isLoading()) {
    <!-- Loading skeleton -->
    <div class="p-4">
      @for (item of [1,2,3,4,5]; track item) {
        <div class="flex gap-4 mb-4">
          <p-skeleton width="100%" height="3rem" />
        </div>
      }
    </div>
  } @else {
    <p-table
      [value]="filteredOccurrences()"
      [paginator]="true"
      [rows]="rowsPerPage()"
      [rowsPerPageOptions]="rowsPerPageOptions"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} ocurrencias"
      [tableStyle]="{ 'min-width': '60rem' }"
      styleClass="p-datatable-sm"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="type">
            Tipo / Razón
            <p-sortIcon field="type" />
          </th>
          <th pSortableColumn="orderId">
            Orden #
            <p-sortIcon field="orderId" />
          </th>
          <th pSortableColumn="posgc">
            POSGC
            <p-sortIcon field="posgc" />
          </th>
          <th pSortableColumn="channel">
            Canal
            <p-sortIcon field="channel" />
          </th>
          <th pSortableColumn="store">
            Unidad
            <p-sortIcon field="store" />
          </th>
          <th pSortableColumn="createdAt">
            Fecha
            <p-sortIcon field="createdAt" />
          </th>
          <th pSortableColumn="createdBy">
            Usuario Solicitante
            <p-sortIcon field="createdBy" />
          </th>
          <th>Solución</th>
          <th>Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-occurrence>
        <tr>
          <!-- Tipo / Razón -->
          <td>
            <div class="flex flex-col gap-1">
              <span class="font-semibold text-sm">{{ occurrence.type }}</span>
              <span class="text-xs text-gray-600">{{ occurrence.reason }}</span>
            </div>
          </td>

          <!-- Orden # -->
          <td>
            <span class="font-mono text-primary cursor-pointer hover:underline" (click)="viewOrder(occurrence.orderId)">
              {{ occurrence.orderId }}
            </span>
          </td>

          <!-- POSGC -->
          <td>
            <span class="font-mono text-sm">{{ occurrence.posgc }}</span>
          </td>

          <!-- Canal -->
          <td>{{ occurrence.channel }}</td>

          <!-- Unidad -->
          <td>{{ occurrence.store }}</td>

          <!-- Fecha -->
          <td>
            <span class="text-sm">{{ formatDate(occurrence.createdAt) }}</span>
          </td>

          <!-- Usuario Solicitante -->
          <td>{{ occurrence.createdBy }}</td>

          <!-- Solución -->
          <td>
            <p-button
              [text]="true"
              icon="pi pi-eye"
              severity="info"
              size="small"
              (onClick)="viewSolution(occurrence)"
              [disabled]="!occurrence.solution || occurrence.solution.length === 0"
            />
          </td>

          <!-- Acciones -->
          <td class="text-center">
            <p-button
              icon="pi pi-ellipsis-v"
              [text]="true"
              [rounded]="true"
              severity="secondary"
              size="small"
              (onClick)="actionsMenu.toggle($event)"
            />
            <p-popover #actionsMenu>
              <div class="flex flex-col gap-1 p-2">
                <button
                  class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors"
                  (click)="viewOrder(occurrence.orderId); actionsMenu.hide()"
                >
                  <i class="pi pi-eye text-blue-600"></i>
                  <span>Ver Orden</span>
                </button>
                <button
                  class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-md transition-colors"
                  (click)="editOccurrence(occurrence); actionsMenu.hide()"
                >
                  <i class="pi pi-pencil text-yellow-600"></i>
                  <span>Editar</span>
                </button>
                <button
                  class="flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md transition-colors"
                  (click)="deleteOccurrence(occurrence); actionsMenu.hide()"
                >
                  <i class="pi pi-trash text-red-600"></i>
                  <span>Eliminar</span>
                </button>
              </div>
            </p-popover>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="text-center py-8">
            <div class="flex flex-col items-center gap-3">
              <i class="pi pi-inbox text-4xl text-gray-400"></i>
              <p class="text-gray-600">
                @if (searchTerm()) {
                  No se encontraron ocurrencias con el criterio de búsqueda
                } @else {
                  No hay ocurrencias registradas
                }
              </p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  }
</div>

<!-- Solution View Dialog -->
<app-solution-dialog
  [visible]="showSolutionDialog()"
  [solutions]="selectedSolution()"
  (onClose)="showSolutionDialog.set(false)"
/>

<!-- Edit Occurrence Dialog -->
<app-edit-occurrence-dialog
  [visible]="showEditDialog()"
  [occurrenceId]="selectedOccurrenceId()"
  (onClose)="showEditDialog.set(false)"
  (onSave)="onSolutionSaved()"
/>
