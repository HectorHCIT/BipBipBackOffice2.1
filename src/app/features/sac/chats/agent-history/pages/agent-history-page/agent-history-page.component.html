<div class="p-6">
  <!-- Breadcrumb -->
  <div class="mb-4">
    <p-breadcrumb
      [model]="breadcrumbItems"
      [home]="home"
    />
  </div>

  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-semibold text-gray-800 dark:text-gray-200">
        Historial de Agentes
      </h1>
      <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
        Consulta los cambios de estado de los agentes SAC
      </p>
    </div>
    <div class="flex gap-2">
      <p-button
        icon="pi pi-refresh"
        [text]="true"
        [rounded]="true"
        (onClick)="refreshData()"
        label="Actualizar"
        [loading]="loading()"
      />
    </div>
  </div>

  <!-- Filters Panel (Always Visible) -->
  <div class="bg-white dark:bg-gray-800 rounded-lg p-4 mb-6 border border-gray-200 dark:border-gray-700">
    <form [formGroup]="filterForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="flex flex-col gap-2">
        <label class="font-medium text-sm text-gray-700 dark:text-gray-300">
          <i class="pi pi-calendar mr-1"></i>
          Rango de Fechas
        </label>
        <p-datepicker
          formControlName="dateRange"
          selectionMode="range"
          [showIcon]="true"
          dateFormat="dd/mm/yy"
          placeholder="Seleccione rango"
        />
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          Por defecto se muestra el día actual
        </p>
      </div>
      <div class="flex flex-col gap-2">
        <label class="font-medium text-sm text-gray-700 dark:text-gray-300">
          <i class="pi pi-user mr-1"></i>
          Agente
        </label>
        <p-iconfield iconPosition="left">
          <p-inputicon styleClass="pi pi-search" />
          <input
            pInputText
            formControlName="agentName"
            class="w-full"
            placeholder="Buscar por nombre o usuario"
            (input)="onLocalFilterChange()"
          />
        </p-iconfield>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          Filtro local en los datos cargados
        </p>
      </div>
      <div class="flex flex-col gap-2">
        <label class="font-medium text-sm text-gray-700 dark:text-gray-300">
          <i class="pi pi-circle mr-1"></i>
          Estado
        </label>
        <p-select
          formControlName="status"
          [options]="statusOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Seleccione estado"
          (onChange)="onLocalFilterChange()"
        />
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
          Filtro local en los datos cargados
        </p>
      </div>
      <div class="md:col-span-3 flex gap-2 justify-end">
        <p-button
          label="Limpiar"
          icon="pi pi-times"
          [outlined]="true"
          severity="secondary"
          (onClick)="clearFilters()"
        />
        <p-button
          label="Aplicar"
          icon="pi pi-check"
          (onClick)="applyFilters()"
        />
      </div>
    </form>
  </div>

  <!-- Content Area -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm">
    <!-- Loading State -->
    @if (loading()) {
      <div class="flex flex-col items-center justify-center py-20">
        <p-progressSpinner />
        <span class="mt-4 text-gray-600 dark:text-gray-400">Cargando historial de agentes...</span>
      </div>
    } @else if (!hasEvents()) {
      <!-- Empty State -->
      <div class="flex flex-col items-center justify-center py-20">
        <i class="pi pi-history text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">No hay eventos registrados</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400">Los cambios de estado de los agentes aparecerán aquí</p>
      </div>
    } @else {
      <!-- PrimeNG Table -->
      <p-table
        [value]="dataSource"
        [tableStyle]="{ 'min-width': '50rem' }"
        styleClass="p-datatable-sm"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Agente</th>
            <th>Username</th>
            <th class="text-center">Estado</th>
            <th>Fecha y Hora</th>
            <th>Modificado Por</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-event>
          <tr>
            <!-- Agent Name -->
            <td>
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center">
                  <span class="text-xs font-semibold text-white">
                    {{ event.agentName.charAt(0).toUpperCase() }}
                  </span>
                </div>
                <span class="text-sm font-medium">{{ event.agentName }}</span>
              </div>
            </td>
            <!-- Username -->
            <td>
              <span class="text-sm text-gray-600 dark:text-gray-400">@{{ event.agentUsername }}</span>
            </td>
            <!-- Status -->
            <td class="text-center">
              @if (event.status === 'online') {
                <p-tag severity="success" value="Online" icon="pi pi-check-circle" />
              } @else if (event.status === 'offline') {
                <p-tag severity="danger" value="Offline" icon="pi pi-times-circle" />
              } @else {
                <p-tag severity="warn" value="Break" icon="pi pi-pause-circle" />
              }
            </td>
            <!-- Changed At -->
            <td>
              <span class="text-sm font-medium">
                {{ formatDate(event.changedAt) }}
              </span>
            </td>
            <!-- Changed By -->
            <td>
              <span class="text-sm text-gray-600 dark:text-gray-400">@{{ event.changedBy }}</span>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5">
              <div class="flex flex-col items-center py-12 px-6">
                <i class="pi pi-inbox text-4xl text-gray-300 mb-3"></i>
                <p class="text-center font-medium text-gray-600">
                  No se han encontrado resultados para los filtros aplicados.
                </p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    }
  </div>

  <!-- Paginator -->
  @if (totalRecords > 0) {
    <p-paginator
      [rows]="pageSize()"
      [totalRecords]="totalRecords"
      [first]="pageIndex * pageSize()"
      [rowsPerPageOptions]="[5, 10, 20, 25]"
      (onPageChange)="onPaginateChange($event)"
      class="mt-3"
    />
  }
</div>
