<!-- Toast para notificaciones -->
<p-toast />

<!-- Header -->
<div class="mb-6">
  <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
    Puntos de Emisión
  </h1>
  <p class="text-gray-600 dark:text-gray-400">
    Gestión de puntos de emisión para facturación
  </p>
</div>

<!-- Toolbar: Filtros + Búsqueda + Botón Crear -->
<div class="mb-6 space-y-4">
  <!-- Filtros de estado -->
  <div class="flex flex-wrap gap-2">
    @for (filter of statusFilters(); track filter.idStatus) {
      <p-button
        [label]="filter.label + ' (' + filter.qty + ')'"
        [severity]="activeStatusFilter().idStatus === filter.idStatus ? undefined : 'secondary'"
        [outlined]="activeStatusFilter().idStatus !== filter.idStatus"
        size="small"
        (onClick)="onStatusFilterChange(filter)"
      />
    }
  </div>

  <!-- Búsqueda + Botón Crear -->
  <div class="flex flex-col sm:flex-row gap-3">
    <!-- Input de búsqueda con iconos -->
    <div class="flex-1">
      <p-iconfield iconPosition="left">
        <p-inputicon>
          <i class="pi pi-search"></i>
        </p-inputicon>
        <input
          type="text"
          pInputText
          [(ngModel)]="searchInput"
          (keyup.enter)="onSearch()"
          placeholder="Buscar por nombre..."
          class="w-full"
        />
      </p-iconfield>
    </div>

    <!-- Botón Crear (Primary = Rojo de marca) -->
    <p-button
      label="Crear Punto de Emisión"
      icon="pi pi-plus"
      (onClick)="openCreateDrawer()"
    />
  </div>
</div>

<!-- Tabla -->
<div class="bg-white dark:bg-gray-800 rounded-lg shadow">
  <p-table
    [value]="emissionPoints()"
    [loading]="isLoading()"
    [paginator]="true"
    [rows]="pageSize()"
    [totalRecords]="totalRecords()"
    [lazy]="true"
    (onLazyLoad)="onPageChange($event)"
    [first]="currentPage() * pageSize()"
    [rowsPerPageOptions]="[5, 10, 20]"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
    styleClass="p-datatable-sm p-datatable-striped"
    responsiveLayout="scroll"
  >
    <!-- Loading template -->
    <ng-template pTemplate="loadingbody">
      <tr>
        <td colspan="5" class="text-center py-8">
          <i class="pi pi-spin pi-spinner text-3xl text-gray-400"></i>
          <p class="mt-2 text-gray-500">Cargando...</p>
        </td>
      </tr>
    </ng-template>

    <!-- Empty template -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5" class="text-center py-8">
          <i class="pi pi-inbox text-4xl text-gray-400"></i>
          <p class="mt-2 text-gray-500">No se encontraron puntos de emisión</p>
        </td>
      </tr>
    </ng-template>

    <!-- Header -->
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="emissionPointNumb">
          <div class="flex items-center gap-2">
            Número
            <p-sortIcon field="emissionPointNumb" />
          </div>
        </th>
        <th pSortableColumn="emissionPointName">
          <div class="flex items-center gap-2">
            Nombre
            <p-sortIcon field="emissionPointName" />
          </div>
        </th>
        <th pSortableColumn="emissionPointAddress">
          <div class="flex items-center gap-2">
            Dirección
            <p-sortIcon field="emissionPointAddress" />
          </div>
        </th>
        <th class="text-center">Estado</th>
        <th class="text-center">Acciones</th>
      </tr>
    </ng-template>

    <!-- Body -->
    <ng-template pTemplate="body" let-emissionPoint>
      <tr>
        <!-- Número -->
        <td>
          <span class="font-semibold text-gray-900 dark:text-white">
            {{ emissionPoint.emissionPointNumb }}
          </span>
        </td>

        <!-- Nombre -->
        <td>
          <span class="text-gray-700 dark:text-gray-300">
            {{ emissionPoint.emissionPointName }}
          </span>
        </td>

        <!-- Dirección -->
        <td>
          <span
            class="text-gray-600 dark:text-gray-400"
            [pTooltip]="emissionPoint.emissionPointAddress"
            tooltipPosition="top"
          >
            {{
              emissionPoint.emissionPointAddress.length > 20
                ? (emissionPoint.emissionPointAddress | slice: 0:20) + '...'
                : emissionPoint.emissionPointAddress
            }}
          </span>
        </td>

        <!-- Estado con toggle -->
        <td class="text-center">
          <div class="flex items-center justify-center gap-3">
            <p-tag
              [value]="emissionPoint.emissionPointEnabled ? 'Activo' : 'Inactivo'"
              [severity]="getStatusSeverity(emissionPoint.emissionPointEnabled)"
            />
            <p-toggleSwitch
              [ngModel]="emissionPoint.emissionPointEnabled"
              (ngModelChange)="onStatusToggle(emissionPoint)"
            />
          </div>
        </td>

        <!-- Acciones -->
        <td class="text-center">
          <p-button
            icon="pi pi-pencil"
            severity="secondary"
            [outlined]="true"
            size="small"
            [rounded]="true"
            (onClick)="openEditDrawer(emissionPoint)"
            pTooltip="Editar"
            tooltipPosition="top"
          />
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Drawer de formulario -->
@if (showDrawer()) {
  <app-emission-point-form
    [emissionPointId]="selectedEmissionPointId()"
    (onClose)="closeDrawer()"
    (onSave)="onSaveSuccess()"
  />
}
