<p-dialog
  [visible]="visible()"
  (visibleChange)="visibleChange.emit($event)"
  [modal]="true"
  [closable]="!isVerifying()"
  [closeOnEscape]="!isVerifying()"
  [dismissableMask]="false"
  [style]="{ width: '500px' }"
>
  <ng-template pTemplate="header">
    <div class="flex flex-col">
      <h2 class="text-xl font-semibold m-0">Autorización por Correo</h2>
      <p class="text-sm text-color-secondary m-0 mt-1">Código de verificación requerido</p>
    </div>
  </ng-template>
  <div class="authorization-content">
    <!-- Error message -->
    @if (error()) {
      <p-message
        severity="error"
        [text]="error()!"
        styleClass="w-full mb-4"
      />
    }

    <!-- Step 1: Request code -->
    @if (!codeRequested()) {
      <div class="step-request">
        <div class="text-center mb-4">
          <i class="pi pi-envelope text-6xl text-blue-500 mb-3"></i>
          <h3 class="text-xl font-semibold mb-2">Solicitar Código de Autorización</h3>
          <p class="text-gray-600 mb-4">
            Para enviar esta notificación, necesitas autorizar la acción mediante un código enviado a tu correo.
          </p>
          <p class="text-sm text-gray-500">
            Recibirás un código de 4 dígitos en tu correo electrónico registrado.
          </p>
        </div>

        <div class="flex justify-center">
          <p-button
            label="Solicitar Código"
            icon="pi pi-send"
            (onClick)="requestCode()"
            [loading]="isRequestingCode()"
            [disabled]="!canRequestCode()"
            size="large"
          />
        </div>
      </div>
    }

    <!-- Step 2: Enter code -->
    @if (codeRequested()) {
      <div class="step-verify">
        <div class="text-center mb-4">
          <i class="pi pi-shield text-6xl text-green-500 mb-3"></i>
          <h3 class="text-xl font-semibold mb-2">Ingresa el Código</h3>
          <p class="text-gray-600 mb-2">
            Hemos enviado un código de 4 dígitos a tu correo electrónico.
          </p>

          <!-- Countdown timer -->
          @if (!isCodeExpired()) {
            <div class="countdown-timer mt-3 p-3 bg-blue-50 rounded-lg">
              <div class="flex items-center justify-center gap-2">
                <i class="pi pi-clock text-blue-500"></i>
                <span class="font-semibold text-blue-700">
                  Código válido por: {{ formatCountdown() }}
                </span>
              </div>
            </div>
          }

          @if (isCodeExpired()) {
            <p-message
              severity="warn"
              text="El código ha expirado. Solicita uno nuevo."
              styleClass="w-full mt-3"
            />
          }
        </div>

        <!-- Code input -->
        <div class="field mb-4">
          <label for="authCode" class="block text-center font-semibold mb-3">
            Código de Autorización
          </label>
          <input
            pInputText
            id="authCode"
            type="text"
            inputmode="numeric"
            maxlength="4"
            placeholder="0000"
            [value]="authCode()"
            (input)="onCodeInput($event)"
            [disabled]="isVerifying() || isCodeExpired()"
            class="w-full text-center text-3xl font-mono tracking-widest"
            autocomplete="off"
          />
          <small class="block text-center text-gray-500 mt-2">
            Ingresa los 4 dígitos del código
          </small>
        </div>

        <!-- Verify button -->
        <div class="flex flex-col gap-2">
          <p-button
            label="Verificar y Enviar"
            icon="pi pi-check"
            (onClick)="verifyCode()"
            [loading]="isVerifying()"
            [disabled]="!canVerify() || isCodeExpired()"
            styleClass="w-full"
            size="large"
          />

          <!-- Request new code -->
          @if (isCodeExpired()) {
            <p-button
              label="Solicitar Nuevo Código"
              icon="pi pi-refresh"
              [outlined]="true"
              (onClick)="requestCode()"
              [loading]="isRequestingCode()"
              styleClass="w-full"
            />
          }
        </div>

        <!-- Help text -->
        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-600 m-0">
            <i class="pi pi-info-circle mr-2"></i>
            ¿No recibiste el código? Verifica tu bandeja de entrada y carpeta de spam, o contacta a soporte.
          </p>
        </div>
      </div>
    }
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-end">
      <p-button
        label="Cancelar"
        severity="secondary"
        [outlined]="true"
        (onClick)="cancel()"
        [disabled]="isVerifying()"
      />
    </div>
  </ng-template>
</p-dialog>
