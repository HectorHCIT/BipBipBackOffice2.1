<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="w-full md:w-[700px]"
>
  <ng-template pTemplate="header">
    <div class="flex flex-col">
      <h2 class="text-xl font-semibold m-0">{{ notification()?.titlePN || 'Detalles de Notificación' }}</h2>
      @if (notification(); as notif) {
        <p class="text-sm text-color-secondary m-0 mt-1">#{{ notif.codPN }} • {{ notif.isPushNotification ? 'Push Notification' : 'SMS' }}</p>
      }
    </div>
  </ng-template>
  @if (notification(); as notif) {
    <div class="flex flex-col gap-6">
      <!-- Status Badges -->
      <div class="flex flex-wrap gap-2">
        <p-tag
          [value]="processedLabel()"
          [severity]="notif.isProcessed ? 'success' : 'warn'"
          [icon]="notif.isProcessed ? 'pi pi-check-circle' : 'pi pi-clock'"
        />
        <p-tag
          [value]="statusLabel()"
          [severity]="notif.status ? 'success' : 'danger'"
          [icon]="notif.status ? 'pi pi-check' : 'pi pi-times'"
        />
        <p-tag
          [value]="typeLabel()"
          [severity]="typeSeverity()"
          [icon]="typeIcon()"
        />
        @if (launchTypeLabel()) {
          <p-tag
            [value]="launchTypeLabel()"
            severity="info"
            icon="pi pi-calendar"
          />
        }
      </div>

      <!-- Basic Information -->
      <div class="border border-surface-200 rounded-lg p-4">
        <h3 class="text-base font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="pi pi-info-circle text-primary"></i>
          Información Básica
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p class="text-xs font-semibold text-gray-600 mb-1">ID</p>
            <p class="text-sm text-gray-800">#{{ notif.codPN }}</p>
          </div>
          <div>
            <p class="text-xs font-semibold text-gray-600 mb-1">Tipo</p>
            <p class="text-sm text-gray-800">{{ notif.isPushNotification ? 'Push Notification' : 'SMS' }}</p>
          </div>
          @if (formattedScheduleDate()) {
            <div class="md:col-span-2">
              <p class="text-xs font-semibold text-gray-600 mb-1">Fecha Programada</p>
              <p class="text-sm text-gray-800">{{ formattedScheduleDate() }}</p>
            </div>
          }
        </div>
      </div>

      <!-- Content -->
      <div class="border border-surface-200 rounded-lg p-4">
        <h3 class="text-base font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="pi pi-file-edit text-primary"></i>
          Contenido
        </h3>
        <div class="flex flex-col gap-3">
          <div>
            <p class="text-xs font-semibold text-gray-600 mb-1">Título</p>
            <p class="text-sm text-gray-800">{{ notif.titlePN }}</p>
          </div>
          @if (notif.bodyPN) {
            <div>
              <p class="text-xs font-semibold text-gray-600 mb-1">Descripción</p>
              <p class="text-sm text-gray-800 whitespace-pre-wrap">{{ notif.bodyPN }}</p>
            </div>
          }
        </div>
      </div>

      <!-- Target Audience -->
      @if (notif.targets && notif.targets.length > 0) {
        <div class="border border-surface-200 rounded-lg p-4">
          <h3 class="text-base font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <i class="pi pi-users text-primary"></i>
            Público Objetivo
          </h3>
          <div class="flex flex-wrap gap-2">
            @for (target of notif.targets; track target) {
              <p-tag [value]="target" severity="secondary" />
            }
          </div>
        </div>
      }

      <!-- Warning if cannot activate -->
      @if (!canActivate() && !notif.isProcessed) {
        <div class="border border-orange-200 bg-orange-50 rounded-lg p-4">
          <div class="flex gap-3">
            <i class="pi pi-exclamation-triangle text-orange-600 mt-0.5"></i>
            <div class="flex-1">
              <p class="text-sm font-semibold text-orange-800 mb-1">No se puede activar</p>
              <p class="text-xs text-orange-700">
                @if (!notif.status) {
                  La notificación está inactiva.
                } @else if (!notif.isPushNotification) {
                  Solo las notificaciones Push pueden ser activadas manualmente.
                } @else {
                  Esta notificación no cumple los requisitos para ser activada.
                }
              </p>
            </div>
          </div>
        </div>
      }

      <!-- Already processed message -->
      @if (notif.isProcessed) {
        <div class="border border-green-200 bg-green-50 rounded-lg p-4">
          <div class="flex gap-3">
            <i class="pi pi-check-circle text-green-600 mt-0.5"></i>
            <div class="flex-1">
              <p class="text-sm font-semibold text-green-800 mb-1">Notificación Enviada</p>
              <p class="text-xs text-green-700">
                Esta notificación ya ha sido procesada y enviada exitosamente.
              </p>
            </div>
          </div>
        </div>
      }
    </div>
  }

  <!-- Footer with actions -->
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button
        label="Cerrar"
        severity="secondary"
        [outlined]="true"
        (onClick)="visible.set(false)"
      />
      @if (canActivate()) {
        <p-button
          label="Activar Push"
          severity="primary"
          icon="pi pi-send"
          (onClick)="openActivationDialog()"
        />
      }
    </div>
  </ng-template>
</p-dialog>

<!-- SMS Authorization Dialog -->
@if (notificationId()) {
  <app-sms-authorization-dialog
    [(visible)]="showSmsDialog"
    [notificationId]="notificationId()!"
    (authorized)="onAuthorizationSuccess()"
    (cancelled)="onAuthorizationCancel()"
  />
}
