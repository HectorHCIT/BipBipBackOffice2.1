<div class="p-4">
  @if (isLoadingBenefits()) {
    <div class="flex justify-center items-center py-8">
      <p-progressSpinner />
    </div>
  }

  @if (errorBenefits()) {
    <p-message severity="error" [text]="errorBenefits()!" styleClass="w-full mb-4" />
  }

  @if (availableBenefits()) {
    <p-card>
      <ng-template pTemplate="header">
        <div class="p-4 pb-0">
          <h3 class="text-xl font-semibold m-0">Otorgar Beneficios al Usuario</h3>
        </div>
      </ng-template>

      <form [formGroup]="grantBenefitForm()" (ngSubmit)="onSubmit()" class="space-y-4">
        <!-- Benefit Selection -->
        <div>
          <label for="benefit" class="block text-sm font-medium mb-2">Beneficio</label>
          <p-select
            id="benefit"
            formControlName="itemId"
            [options]="availableBenefits()!"
            optionLabel="loyaltyNameWallet"
            optionValue="idLoyaltyItemWallet"
            placeholder="Seleccione un beneficio"
            styleClass="w-full"
            (onChange)="onBenefitChange($event)"
          >
            <ng-template pTemplate="item" let-benefit>
              <div class="flex justify-between items-center w-full">
                <div>
                  <div class="font-semibold">{{ benefit.loyaltyNameWallet }}</div>
                  <div class="text-sm text-gray-600">{{ benefit.loyaltyDescriptionWallet }}</div>
                </div>
                <div class="text-right">
                  <div class="text-xs text-gray-600">Nivel: {{ benefit.codLoyaltyLevel }}</div>
                  <div class="text-xs text-gray-600">Max: {{ benefit.maxItemWallet }}</div>
                </div>
              </div>
            </ng-template>
          </p-select>
          @if (grantBenefitForm().get('itemId')?.invalid && grantBenefitForm().get('itemId')?.touched) {
            <small class="text-red-600">El beneficio es requerido</small>
          }
        </div>

        <!-- Selected Benefit Details -->
        @if (selectedBenefit()) {
          <p-message
            severity="info"
            styleClass="w-full"
          >
            <ng-template pTemplate>
              <div class="flex flex-col gap-2">
                <div><strong>Beneficio:</strong> {{ selectedBenefit()!.loyaltyNameWallet }}</div>
                <div><strong>Descripción:</strong> {{ selectedBenefit()!.loyaltyDescriptionWallet }}</div>
                <div><strong>Nivel de Lealtad:</strong> {{ selectedBenefit()!.codLoyaltyLevel }}</div>
                <div><strong>Máximo:</strong> {{ selectedBenefit()!.maxItemWallet }}</div>
              </div>
            </ng-template>
          </p-message>
        }

        <!-- Quantity -->
        <div>
          <label for="quantity" class="block text-sm font-medium mb-2">Cantidad</label>
          <p-inputNumber
            id="quantity"
            formControlName="quantity"
            [min]="1"
            [max]="selectedBenefit()?.maxItemWallet || 100"
            placeholder="Ingrese la cantidad"
            styleClass="w-full"
          />
          @if (grantBenefitForm().get('quantity')?.invalid && grantBenefitForm().get('quantity')?.touched) {
            <small class="text-red-600">La cantidad debe ser mayor a 0</small>
          }
        </div>

        <!-- Error Message -->
        @if (error()) {
          <p-message severity="error" [text]="error()!" styleClass="w-full" />
        }

        <!-- Success Message -->
        @if (success()) {
          <p-message severity="success" [text]="success()!" styleClass="w-full" />
        }

        <!-- Actions -->
        <div class="flex justify-end gap-2">
          <p-button
            type="button"
            label="Cancelar"
            severity="secondary"
            [outlined]="true"
            (onClick)="resetForm()"
          />
          <p-button
            type="submit"
            label="Otorgar Beneficio"
            [loading]="isSubmitting()"
            [disabled]="grantBenefitForm().invalid"
          />
        </div>
      </form>
    </p-card>
  }
</div>
