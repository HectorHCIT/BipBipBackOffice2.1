<p-drawer
  [(visible)]="visibleModel"
  (visibleChange)="onVisibleChange($event)"
  header="Filtros Avanzados"
  position="right"
  styleClass="w-full md:!w-[28rem]"
  [blockScroll]="true"
>
  <form [formGroup]="filterForm" class="flex flex-col gap-6">
    <!-- Date Range Filter -->
    <div>
      <h3 class="text-sm font-semibold mb-3">Rango de Fechas</h3>

      <div class="flex flex-col gap-3">
        <div>
          <label for="from" class="block text-sm font-medium mb-2">Desde</label>
          <p-datepicker
            formControlName="from"
            inputId="from"
            [showIcon]="true"
            iconDisplay="input"
            [maxDate]="maxDate"
            placeholder="Seleccionar fecha inicial"
            styleClass="w-full"
            dateFormat="dd/mm/yy"
          />
        </div>

        <div>
          <label for="to" class="block text-sm font-medium mb-2">Hasta</label>
          <p-datepicker
            formControlName="to"
            inputId="to"
            [showIcon]="true"
            iconDisplay="input"
            [maxDate]="maxDate"
            placeholder="Seleccionar fecha final"
            styleClass="w-full"
            dateFormat="dd/mm/yy"
          />
        </div>
      </div>
    </div>

    <!-- Countries Filter -->
    <div>
      <h3 class="text-sm font-semibold mb-3">Países</h3>

      @if (isLoadingCountries()) {
        <div class="flex items-center justify-center py-4">
          <i class="pi pi-spinner pi-spin text-2xl text-gray-400"></i>
        </div>
      } @else {
        <p-multiselect
          [ngModel]="selectedCountries()"
          (ngModelChange)="onCountryChange($event)"
          [options]="countries()"
          optionLabel="countryName"
          optionValue="countryId"
          placeholder="Seleccionar países"
          [filter]="true"
          filterPlaceHolder="Buscar país..."
          [showClear]="true"
          [ngModelOptions]="{ standalone: true }"
          styleClass="w-full"
        />
      }
    </div>

    <!-- Cities Filter -->
    @if (selectedCountries().length > 0) {
      <div>
        <h3 class="text-sm font-semibold mb-3">Ciudades</h3>

        @if (isLoadingCities()) {
          <div class="flex items-center justify-center py-4">
            <i class="pi pi-spinner pi-spin text-2xl text-gray-400"></i>
          </div>
        } @else {
          <p-multiselect
            [ngModel]="selectedCities()"
            (ngModelChange)="selectedCities.set($event)"
            [options]="filteredCities()"
            optionLabel="cityName"
            optionValue="cityId"
            placeholder="Seleccionar ciudades"
            [filter]="true"
            filterPlaceHolder="Buscar ciudad..."
            [showClear]="true"
            [ngModelOptions]="{ standalone: true }"
            styleClass="w-full"
          />
        }
      </div>
    }
  </form>

  <!-- Footer Actions -->
  <ng-template pTemplate="footer">
    <div class="flex gap-3">
      <p-button
        label="Limpiar"
        severity="secondary"
        [outlined]="true"
        (onClick)="clearFilters()"
        styleClass="flex-1"
      />
      <p-button
        label="Aplicar Filtros"
        (onClick)="applyFilters()"
        styleClass="flex-1"
      />
    </div>
  </ng-template>
</p-drawer>
