<div class="credentials-tab">
  <!-- Search and Filter Section -->
  <div class="mb-4 space-y-4">
    <!-- Search Input -->
    <div class="flex gap-2 w-full sm:w-auto">
      <p-iconfield iconPosition="left" class="flex-1 sm:w-96">
        <p-inputicon styleClass="pi pi-search" />
        <input
          pInputText
          type="text"
          [formControl]="searchControl"
          placeholder="Buscar por nombre o email..."
          class="w-full"
          autocomplete="off"
          (keyup.enter)="onSearch()"
        />
      </p-iconfield>
      <p-button
        label="Buscar"
        icon="pi pi-search"
        size="small"
        (onClick)="onSearch()"
      />
    </div>

    <!-- Status Filters and Actions -->
    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
      <!-- Status Filters -->
      <div class="flex gap-2">
        <p-button
          label="Todos ({{ totalRecords() }})"
          [outlined]="selectedStatus() !== null"
          severity="secondary"
          size="small"
          (onClick)="onStatusFilter(null)"
        />
        <p-button
          label="Activos ({{ activeCount() }})"
          [outlined]="selectedStatus() !== true"
          severity="success"
          size="small"
          (onClick)="onStatusFilter(true)"
        />
        <p-button
          label="Inactivos ({{ inactiveCount() }})"
          [outlined]="selectedStatus() !== false"
          severity="danger"
          size="small"
          (onClick)="onStatusFilter(false)"
        />
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-2">
        <p-button
          label="Nuevo Usuario"
          icon="pi pi-plus"
          size="small"
          (onClick)="onCreateUser()"
        />
      </div>
    </div>
  </div>

  <!-- Desktop Table View -->
  <div class="hidden sm:block">
    <p-table
      [value]="credentials()"
      [loading]="loading()"
      [paginator]="true"
      [rows]="pageSize()"
      [totalRecords]="totalRecords()"
      [lazy]="true"
      [rowsPerPageOptions]="[5, 10, 15, 20]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuarios"
      (onLazyLoad)="onPageChange($event)"
      styleClass="p-datatable-sm"
    >
      <ng-template #header>
        <tr>
          <th style="width: 3rem"></th>
          <th>Usuario</th>
          <th>Rol</th>
          <th>Teléfono</th>
          <th>Email</th>
          <th>Ciudad</th>
          <th>Estado</th>
          <th style="width: 8rem">Acciones</th>
        </tr>
      </ng-template>

      <ng-template #body let-credential>
        <tr>
          <!-- Avatar -->
          <td>
            @if (credential.userImage) {
              <img
                [src]="credential.userImage"
                [alt]="credential.userName"
                class="w-8 h-8 rounded-full object-cover"
              />
            } @else {
              <p-avatar
                [label]="getInitials(credential.userName)"
                shape="circle"
                styleClass="bg-primary text-white"
              />
            }
          </td>

          <!-- User Name -->
          <td>
            <span class="font-semibold">{{ credential.userName }}</span>
          </td>

          <!-- Role -->
          <td>
            <p-tag [value]="credential.roleName" severity="info" />
          </td>

          <!-- Phone -->
          <td>{{ credential.userPhone || '-' }}</td>

          <!-- Email -->
          <td>{{ credential.userEmail }}</td>

          <!-- City -->
          <td>
            <div class="flex flex-col">
              <span>{{ credential.cityName }}</span>
              <span class="text-sm text-muted-color">{{ credential.countryName }}</span>
            </div>
          </td>

          <!-- Status -->
          <td>
            <p-tag
              [value]="credential.userActive ? 'Activo' : 'Inactivo'"
              [severity]="credential.userActive ? 'success' : 'danger'"
            />
          </td>

          <!-- Actions -->
          <td>
            <p-button
              icon="pi pi-ellipsis-v"
              [text]="true"
              [rounded]="true"
              size="small"
              (click)="popover.toggle($event)"
            />
            <p-popover #popover>
              <div class="flex flex-col gap-1 p-1 min-w-[180px]">
                <button
                  class="flex items-center gap-3 px-3 py-2 text-left hover:surface-hover rounded transition-colors"
                  (click)="onEditUser(credential); popover.hide()"
                >
                  <i class="pi pi-pencil"></i>
                  <span>Editar</span>
                </button>
                <div class="border-t my-1"></div>
                <button
                  class="flex items-center gap-3 px-3 py-2 text-left hover:surface-hover rounded transition-colors"
                  [class.text-red-600]="credential.userActive"
                  [class.text-green-600]="!credential.userActive"
                  (click)="onToggleStatus(credential); popover.hide()"
                >
                  <i class="pi" [class.pi-ban]="credential.userActive" [class.pi-check]="!credential.userActive"></i>
                  <span>{{ credential.userActive ? 'Desactivar' : 'Activar' }}</span>
                </button>
              </div>
            </p-popover>
          </td>
        </tr>
      </ng-template>

      <ng-template #emptymessage>
        <tr>
          <td colspan="8" class="text-center py-8">
            <div class="flex flex-col items-center gap-3">
              <i class="pi pi-users text-4xl text-gray-400"></i>
              <span class="text-gray-600">No se encontraron usuarios</span>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Mobile Cards View -->
  <div class="block sm:hidden">
    @if (loading()) {
      <div class="text-center py-8">
        <i class="pi pi-spin pi-spinner text-3xl text-primary"></i>
        <p class="mt-2 text-gray-600">Cargando...</p>
      </div>
    } @else if (credentials().length === 0) {
      <div class="text-center py-8">
        <i class="pi pi-users text-4xl text-gray-400"></i>
        <p class="mt-2 text-gray-600">No se encontraron usuarios</p>
      </div>
    } @else {
      <div class="space-y-4">
        @for (credential of credentials(); track $index) {
          <div class="border rounded-lg p-4">
            <!-- Header -->
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-3">
                @if (credential.userImage) {
                  <img
                    [src]="credential.userImage"
                    [alt]="credential.userName"
                    class="w-12 h-12 rounded-full object-cover"
                  />
                } @else {
                  <p-avatar
                    [label]="getInitials(credential.userName)"
                    shape="circle"
                    size="large"
                    styleClass="bg-primary text-white"
                  />
                }
                <div>
                  <h3 class="font-semibold">{{ credential.userName }}</h3>
                  <p class="text-sm text-muted-color">{{ credential.userEmail }}</p>
                </div>
              </div>
              <p-button
                icon="pi pi-ellipsis-v"
                [text]="true"
                [rounded]="true"
                size="small"
                (click)="mobilePopover.toggle($event)"
              />
              <p-popover #mobilePopover>
                <div class="flex flex-col gap-1 p-1 min-w-[180px]">
                  <button
                    class="flex items-center gap-3 px-3 py-2 text-left hover:surface-hover rounded transition-colors"
                    (click)="onEditUser(credential); mobilePopover.hide()"
                  >
                    <i class="pi pi-pencil"></i>
                    <span>Editar</span>
                  </button>
                  <div class="border-t my-1"></div>
                  <button
                    class="flex items-center gap-3 px-3 py-2 text-left hover:surface-hover rounded transition-colors"
                    [class.text-red-600]="credential.userActive"
                    [class.text-green-600]="!credential.userActive"
                    (click)="onToggleStatus(credential); mobilePopover.hide()"
                  >
                    <i class="pi" [class.pi-ban]="credential.userActive" [class.pi-check]="!credential.userActive"></i>
                    <span>{{ credential.userActive ? 'Desactivar' : 'Activar' }}</span>
                  </button>
                </div>
              </p-popover>
            </div>

            <!-- Details -->
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-muted-color">Rol:</span>
                <p-tag [value]="credential.roleName" severity="info" />
              </div>
              @if (credential.userPhone) {
                <div class="flex justify-between">
                  <span class="text-muted-color">Teléfono:</span>
                  <span>{{ credential.userPhone }}</span>
                </div>
              }
              <div class="flex justify-between">
                <span class="text-muted-color">Ubicación:</span>
                <span>{{ credential.cityName }}, {{ credential.countryName }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-muted-color">Estado:</span>
                <p-tag
                  [value]="credential.userActive ? 'Activo' : 'Inactivo'"
                  [severity]="credential.userActive ? 'success' : 'danger'"
                />
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Mobile Pagination -->
      <div class="mt-4 flex justify-center">
        <p-button
          label="Cargar más"
          icon="pi pi-refresh"
          [disabled]="credentials().length >= totalRecords()"
          (onClick)="loadMore()"
        />
      </div>
    }
  </div>

  <!-- Credentials Form Drawer -->
  @if (isFormOpen()) {
    <app-credentials-form
      [credential]="selectedCredentialForEdit()"
      (formClosed)="onFormClose($event)"
    />
  }
</div>
